"use strict";!function(e){AjaxSolr.AbstractJQueryWidget=AjaxSolr.AbstractWidget.extend({defaults:{},options:{},$target:null,init:function(){var t=this;t.$target=e(t.target),t.options=e.extend({},t.defaults,t.options,t.$target.data())}})}(jQuery),function(e){AjaxSolr.AbstractJQueryFacetWidget=AjaxSolr.AbstractFacetWidget.extend({defaults:{facetType:"facet_fields",facetMincount:1,multiValue:!1,union:!1,exclusion:!1,label:null,exclude:null,include:null,facetSortReverse:!1},options:{},$target:null,facetCounts:[],isSelected:function(e){var t=this.getQueryByKey(e);return t&&(e=t.value),e=e.toString().replace(/^(.*?):/,""),this.inQuery(e)>=0},getQueryByKey:function(e){var t=this;if(t.queries)for(var a=0,n=t.queries.length;a<n;a++)if(t.queries[a].key==e)return t.queries[a]},getQueryByValue:function(e){var t=this;if(t.queries)for(var a=0,n=t.queries.length;a<n;a++)if(t.queries[a].value==e)return t.queries[a]},getFacetCounts:function(){var t=this,a=this._super(),n=[];return 0==t.options.facetMincount?a:(e.each(a,(function(e,a){!(a.count>=t.options.facetMincount)||t.options.exclude&&a.facet.match(t.options.exclude)||t.options.include&&!a.facet.match(t.options.include)||n.push(a)})),t.options.facetSortReverse?n.reverse():n)},init:function(){var t=this;switch(t.$target=e(t.target),t.options=e.extend({},t.defaults,t.options,t.$target.data()),t.facetType=t.options.facetType,t["facet.mincount"]=t.options.facetMincount,t["facet.sort"]=t.options.facetSort,t["facet.prefix"]=t.options.facetPrefix,t["facet.limit"]=t.options.facetLimit,t["facet.offset"]=t.options.facetOffset,t["facet.missing"]=t.options.facetMissing,t["facet.method"]=t.options.facetMethod,t["facet.enum.cache.minDf"]=t.options.facetEnumCacheMinDf,t.facetType){case"facet_dates":t["facet.date.start"]=t.options.facetDateStart,t["facet.date.end"]=t.options.facetDateEnd,t["facet.date.gap"]=t.options.facetDateGap,t["facet.date.hardend"]=t.options.facetDateHardend,t["facet.date.other"]=t.options.facetDateOther,t["facet.date.include"]=t.options.facetDateInclude;break;case"facet_ranges":t["facet.range.start"]=t.options.facetRangeStart,t["facet.range.end"]=t.options.facetRangeEnd,t["facet.range.gap"]=t.options.facetRangeGap,t["facet.range.hardend"]=t.options.facetRangeHardend,t["facet.range.other"]=t.options.facetRangeOther,t["facet.range.include"]=t.options.facetRangeInclude}t.key=t.options.label,t.field=t.options.field;var a=t.manager.store.get("fl"),n=a.val();(null==n?a.val([t.field]):n.push(t.field),t.options.union&&(t.multivalue=!0,t.union=t.options.union),t.options.multiValue?(t.tag=t.tag||t.field,t.multivalue=!0):t.multivalue=!1,t.options.exclusion&&(t.tag=t.tag||t.field,t.ex=t.tag),void 0!==t.options.defaultValue)&&t[t.multivalue?t.union?"append":"add":"set"].call(t,t.options.defaultValue);t._super()}})}(jQuery),function(e){AjaxSolr.FacetFieldWidget=AjaxSolr.AbstractJQueryFacetWidget.extend({defaults:{templateName:"#solrFacetFieldTemplate",container:".solrFacetFieldContainer",filterField:".solrFacetFieldFilter>input",hideNullValues:!0,hideSingle:!0,name:null,dateFormat:null},facetType:"facet_queries",template:null,container:null,filterField:null,paramString:null,inputType:null,inputClass:null,initQueries:function(){var t=e(this.target).find(".solrJsonData").text();t&&(this.queries=e.parseJSON(t))},getFacetValue:function(e){var t=this.getQueryByKey(e);return t&&t.value?t.value:e},getFacetKey:function(t){var a;return this.options.dateFormat?e.datepicker.formatDate(this.options.dateFormat,new Date(t)):(a=this.getQueryByValue(t))&&a.key?a.key:_(t)},afterRequest:function(){var t=this,a=t.manager.store.string().replace(/&?start=\d*/g,"");if(t.paramString!=a&&(t.paramString=a,t.facetCounts=t.getFacetCounts(),t.$target.hide(),0!=t.facetCounts.length&&(!this.options.hideSingle||1!=t.facetCounts.length))){if(t.container.html(t.template.render({widget:t},{checked:function(e){return t.isSelected(e)?"checked='checked'":""},selected:function(e){return t.isSelected(e)?"selected='selected'":""},getFacetValue:function(e){return t.getFacetValue(e)},getFacetKey:function(e){return t.getFacetKey(e)}})),t.container.find("input[type='"+t.inputType+"'], select").on("change",(function(){var a=e(this),n=a.attr("title"),r=a.val();"facet_ranges"==t.facetType&&(r=r+" TO "+r+t["facet.range.gap"],n&&AjaxSolr.Dicts.default.set(r,n),r="["+r+"]"),""==r?(t.clear(),t.manager.doRequest(0)):a.is(":checked, select")?t.clickHandler(r).call(t):t.unclickHandler(r).call(t)})),t.filterField&&t.filterField.is(":visible")){var n=t.filterField.val();void 0!==n&&t.container.find(".jqSerialPager").data("filter",n)}t.$target.children("h2").each((function(){var a=e(this).text();a&&AjaxSolr.Dicts.default.set(t.field,a)})),t.$target.fadeIn()}},init:function(){var t,a=this;a.initQueries(),a._super(),a.template=e.templates(a.options.templateName),a.container=a.$target.find(a.options.container),a.filterField=a.$target.find(a.options.filterField),a.inputType="checkbox",a.inputClass="checkbox"===a.inputType?"foswikiCheckbox":"foswikiRadioButton",a.$target.addClass("solrFacetContainer"),a.$target.find(".solrFacetFieldTwisty").on("afterClose.twisty",(function(){void 0!==a.filterField.val()&&a.container.find(".jqSerialPager").trigger("refresh"),a.filterField.blur()})).on("afterOpen.twisty",(function(){var e=a.filterField.val();void 0!==e&&a.container.find(".jqSerialPager").trigger("refresh",e),a.filterField.focus()})),a.filterField.on("keyup",(function(n){var r=e(this).val(),i=a.container.find(".jqSerialPager");i.length&&(void 0!==t&&(clearTimeout(t),t=void 0),t=window.setTimeout((function(){i.trigger("refresh",r),t=void 0}),250))}))}}),AjaxSolr.Helpers.build("FacetFieldWidget")}(jQuery),jQuery,AjaxSolr.WebFacetWidget=AjaxSolr.FacetFieldWidget.extend({facetType:"facet_fields",keyOfValue:{},getFacetKey:function(e){var t=this.keyOfValue[e];return t||e},getFacetCounts:function(){for(var e,t=this,a=t._super(),n=0,r=a.length;n<r;n++)e=a[n].facet,t.keyOfValue[e]=a[n].key=_(e);return"title"===t.options.facetSort&&a.sort((function(e,t){var a=e.key.toLowerCase(),n=t.key.toLowerCase();return a<n?-1:a>n?1:0})),a}}),AjaxSolr.Helpers.build("WebFacetWidget"),function(e){AjaxSolr.ToggleWidget=AjaxSolr.AbstractJQueryWidget.extend({options:{templateName:"#solrToggleTemplate",value:null,inverseValue:null,inverse:!1},checkbox:null,remove:function(e){var t=this;return void 0===e?t.manager.store.remove(t.field):t.manager.store.removeByValue(t.field,e),!0},add:function(e){var t=this;return t.manager.store.add(t.field,new AjaxSolr.Parameter({name:t.field,value:e}))},isSelected:function(e){var t=!1,a=this.manager.store.get(this.field);if(void 0!==a)if(AjaxSolr.isArray(a)){for(var n=0,r=a.length;n<r;n++)if(a[n].val()===e){t=!0;break}}else t=a.val()===e;return t},afterRequest:function(){var e=this;e.isSelected(e.options.value)?e.options.inverse?e.checkbox.prop("checked",!1):e.checkbox.prop("checked",!0):e.options.inverse?e.checkbox.prop("checked",!0):e.checkbox.prop("checked",!1)},clickHandler:function(e){var t=this;return function(){return t.add(e)&&t.doRequest(0),!1}},unclickHandler:function(e){var t=this;return function(){return t.remove(e)&&t.doRequest(0),!1}},init:function(){var t=this;t._super(),t.$target.append(e(t.options.templateName).render({id:AjaxSolr.Helpers.getUniqueID(),title:t.options.title})),t.checkbox=t.$target.find("input[type='checkbox']").on("change",(function(){e(this).is(":checked")?t.options.inverse?(t.unclickHandler(t.options.value).call(t),t.options.inverseValue&&t.clickHandler(t.options.inverseValue).call(t)):(t.clickHandler(t.options.value).call(t),t.options.inverseValue&&t.unclickHandler(t.options.inverseValue).call(t)):t.options.inverse?(t.clickHandler(t.options.value).call(t),t.options.inverseValue&&t.unclickHandler(t.options.inverseValue).call(t)):(t.unclickHandler(t.options.value).call(t),t.options.inverseValue&&t.clickHandler(t.options.inverseValue).call(t))})),t.options.inverse?(t.add(t.options.value),t.options.inverseValue&&t.remove(t.options.inverseValue)):(t.options.inverseValue&&t.add(t.options.inverseValue),t.remove(t.options.value))}}),AjaxSolr.Helpers.build("ToggleWidget")}(jQuery),function(e){AjaxSolr.ToggleFacetWidget=AjaxSolr.AbstractJQueryFacetWidget.extend({options:{templateName:"#solrToggleFacetTemplate",value:null,inverseValue:null,inverse:!1,exclude:!1,checked:void 0},checkbox:null,afterRequest:function(){var e=this;e.isSelected(e.options.value)?e.options.inverse||e._isExclude?e.checkbox.prop("checked",!1):e.checkbox.prop("checked",!0):e.options.inverse?e.checkbox.prop("checked",!0):e.checkbox.prop("checked",!1)},_updateValues:function(e){var t=this;t._isExclude=!1,e?t.options.inverse?(t.remove(t.options.value),t.options.exclude&&(t._isExclude=!0,t.add(t.options.value,!0)),t.options.inverseValue&&t.add(t.options.inverseValue)):(t.options.inverseValue&&t.remove(t.options.inverseValue),t.options.exclude&&t.remove(t.options.value,!0),t.add(t.options.value)):t.options.inverse?(t.add(t.options.value),t.options.exclude&&t.remove(t.options.value,!0),t.options.inverseValue&&t.remove(t.options.inverseValue)):(t.options.inverseValue&&t.add(t.options.inverseValue),t.options.exclude&&(t._isExclude=!0,t.add(t.options.value,!0)),t.remove(t.options.value))},init:function(){var t=this;t._super(),t.$target.append(e(t.options.templateName).render({id:AjaxSolr.Helpers.getUniqueID(),title:t.options.title})),t.checkbox=t.$target.find("input[type='checkbox']").on("change",(function(){t._updateValues(e(this).is(":checked")),t.doRequest(0)})),void 0!==t.options.checked&&t._updateValues(t.options.checked)}}),AjaxSolr.Helpers.build("ToggleFacetWidget")}(jQuery),function(e){AjaxSolr.PagerWidget=AjaxSolr.AbstractJQueryWidget.extend({defaults:{prevText:"Previous",nextText:"Next"},perPage:function(){return parseInt(this.manager.response.responseHeader&&this.manager.response.responseHeader.params&&this.manager.response.responseHeader.params.rows||this.manager.store.get("rows").val()||10)},clickHandler:function(e){var t=this;return function(){var a=e*t.perPage();return t.manager.doRequest(a),!1}},afterRequest:function(){var t,a,n,r,i=this,o=i.manager.response,s=o.responseHeader,l=parseInt(s.params&&s.params.rows||20),c=parseInt(o.response.numFound),u=parseInt(s.params&&s.params.start||0);if(i.$target.empty(),(r=Math.ceil(c/l)-1)<=0)i.$target.hide();else{i.$target.show(),(n=Math.ceil(u/l))>0?e("<a href='#' class='solrPagerPrev'>"+i.options.prevText+"</a>").on("click",i.clickHandler(n-1)).appendTo(i.$target):i.$target.append("<span class='solrPagerPrev foswikiGrayText'>"+i.options.prevText+"</span>"),t=n-4,(a=n+4)>=r&&(t-=a-r+1,a=r),t<0&&(a-=t,t=0),a>r&&(a=r),t>0&&e("<a href='#'>1</a>").on("click",i.clickHandler(0)).appendTo(i.$target),t>1&&i.$target.append("<span class='solrPagerEllipsis'>&hellip;</span>");for(var d=t;d<=a;d++)e("<a href='' class='"+(d==n?"current":"")+"'>"+(d+1)+"</a>").on("click",i.clickHandler(d)).appendTo(i.$target);a<r-1&&i.$target.append("<span class='solrPagerEllipsis'>&hellip;</span>"),a<r&&e("<a href='#' class='"+(n==r?"current":"")+"'>"+(r+1)+"</a>").on("click",i.clickHandler(r)).appendTo(i.$target),n<r?e("<a href='#' class='solrPagerNext'>"+i.options.nextText+"</a>").on("click",i.clickHandler(n+1)).appendTo(i.$target):i.$target.append("<span class='solrPagerNext foswikiGrayText'>"+i.options.nextText+"</span>")}}}),AjaxSolr.Helpers.build("PagerWidget")}(jQuery),function(e){AjaxSolr.AlphaPagerWidget=AjaxSolr.AbstractJQueryFacetWidget.extend({defaults:{allText:"All",union:!0,title:"alpha",exclusion:!0,enableScroll:!1,scrollTarget:".solrPager:first",scrollSpeed:250},getCurrentVal:function(){for(var e,t,a,n=this.manager.store.values("fq"),r=0,i=n.length;r<i;r++)if(a=(t=n[r].match(/^(?:{!.*?})?(.*?):(.*)$/))[1],e=t[2],a===this.field)return e},afterRequest:function(){var t,a=this,n=a.getCurrentVal()||"";a.$target.empty(),a.facetCounts=a.getFacetCounts(),e("<a href='#' class='"+(t=n?"":"current")+"'>"+a.options.allText+"</a>").on("click",a.unclickHandler(n)).appendTo(a.$target),e.each(a.facetCounts.sort((function(e,t){var a=e.facet.toUpperCase(),n=t.facet.toUpperCase();return a<n?-1:a>n?1:0})),(function(r,i){t=n==i.facet?"current":"",e("<a href='#' class='"+t+"'>"+i.facet+"</a>").on("click",a.clickHandler(i.facet)).appendTo(a.$target)}))},init:function(){var e=this;e._super(),AjaxSolr.Dicts.default.set(e.field,e.options.title)}}),AjaxSolr.Helpers.build("AlphaPagerWidget")}(jQuery),function(e){AjaxSolr.ResultsPerPageWidget=AjaxSolr.AbstractJQueryWidget.extend({defaults:{templateName:"#solrResultsPerPageTemplate"},template:null,afterRequest:function(){var e=this,t=e.manager.response.responseHeader,a=parseInt(e.manager.store.get("rows").val()),n=parseInt(e.manager.response.response.numFound),r=parseInt(t.params&&t.params.start||0),i=r+a;i>n&&(i=n),e.$target.html(e.template.render({from:r+1,to:i,count:n}))},init:function(){var t=this;if(t._super(),t.template=e.templates(t.options.templateName),!t.template)throw"template "+t.options.templateName+" not found"}}),AjaxSolr.Helpers.build("ResultsPerPageWidget")}(jQuery),function(e){AjaxSolr.ResultWidget=AjaxSolr.AbstractJQueryWidget.extend({defaults:{maxHilite:600,blockUi:"#solrSearch",firstLoadingMessage:"Loading ...",loadingMessage:"",displayAs:".solrDisplay",defaultDisplay:"list",dateFormat:"dddd, Do MMMM YYYY, HH:mm",dictionary:"default",enableScroll:!0,scrollTarget:".solrSearchHits",byteSuffix:["B","KB","MB","GB","TB","PB","EB","ZB"]},scrollIntoView:function(){var t;this.options.enableScroll&&(t=e(this.options.scrollTarget)[0]).getBoundingClientRect().top<0&&t.scrollIntoView({block:"start",inline:"nearest",behavior:"smooth"})},beforeRequest:function(){var t=this;t._isFirst?e.blockUI({message:"<h1>"+_(t.options.firstLoadingMessage,t.options.dictionary)+"</h1>"}):e(t.options.blockUi).block({message:"<h1>"+_(t.options.loadingMessage,t.options.dictionary)+"</h1>"})},getSnippet:function(e){return e.text?e.text.substr(0,300)+" ...":""},escapeHtml:function(t){return e("<div />").text(t).html().replace(/&lt;em&gt;/g,"<em>").replace(/&lt;\/em&gt;/g,"</em>")},afterRequest:function(){var t=this,a=t.manager.response;t._isFirst?(t._isFirst=!1,e.unblockUI()):e(t.options.blockUi).unblock(),e("#solrSearch").is(":visible")||e("#solrSearch").fadeIn(),e.each(a.response.docs,(function(e,t){var a=t.container_web,n=t.container_topic;"topic"===t.type&&(t.url=foswiki.getScriptUrl("view",t.web,t.topic)),void 0!==a&&void 0!==n||void 0!==t.container&&t.container_id.match(/^(.*)\.(.*)$/)&&(a=RegExp.$1,n=RegExp.$2),void 0!==a&&void 0!==n&&(t.container_url=foswiki.getScriptUrl("view",a,n))})),t.$target.html(e("#solrHitTemplate").render(a.response.docs,{debug:function(e){return console.log(e||"",this),""},encodeURIComponent:function(e){return encodeURIComponent(e)},getPubUrlPath:function(e,t,a,n){return foswiki.getPubUrlPath(e,t,a,n)},getScriptUrlPath:function(e,t,a,n){return foswiki.getScriptUrlPath(e,t,a,n)},getTemplateName:function(){var t,a,n,r,i,o,s=this.data.field_TopicType_lst||[];for(n=0,i=this.data.type.length;n<i;n++){if("file"===(t=this.data.type[n].replace(/%\d+/g,"")))return"#solrHitTemplate_file";for(a=0,r=s.length;a<r;a++)if(o="#solrHitTemplate_"+s[a].replace(/[\s\(\)]+/g,"_"),e(o).length)return o;if("topic"===t)return"#solrHitTemplate_topic";if(t.match(/png|gif|jpe?g|tiff|bmp/))return"#solrHitTemplate_image";if(e(o="#solrHitTemplate_"+t).length)return o}return"#solrHitTemplate_misc"},renderList:function(a,n,r){var i,o=this.data[a],s="";return n=n||", ",r=r||10,o&&o.length&&(i=[],e.each(o.sort().slice(0,r),(function(e,a){i.push(_(a,t.options.dictionary))})),s+=i.join(n),o.length>r&&(s+=" ...")),s},renderTopicInfo:function(){var t,a=this.data,n=a.field_Category_link_lst,r=a.tag,i="";return n&&n.length&&(i+='<i class="fa fa-folder"></i>',t=[],e.each(n.sort().slice(0,10),(function(e,a){t.push(a)})),i+=t.join(", "),n.length>10&&(i+=" ...")),r&&r.length&&(n&&n.length&&(i+="<span class='solrSep'>&#124;</span>"),i+='<i class="fa fa-tag"></i>',i+=r.sort().slice(0,10).join(", "),r.length>10&&(i+=" ...")),i},getHilite:function(e){var n,r=[];return void 0===a.highlighting||void 0===(n=a.highlighting[e])||void 0===n.text?"":(n.text.forEach((function(e){var a=t.escapeHtml(e);r.push(a)})),r.join(" ... "))},getIcon:function(e){var t,a="solrHitIcon foswikiIcon jqIcon";return(e=e||"fa-file-o").startsWith("http")?"<img src='"+e+"' class='solrHitIcon' />":((t=e.match(/^(.*?)\-/))&&(a+=" "+t[1]),"<i class='"+(a+=" "+e)+"'></i>")},formatDate:function(e,a){return/^\d+$/.test(e)&&(10==e.length&&(e+="000"),e=new Date(parseInt(e)).toISOString()),void 0===e||""==e||"0"==e||"1970-01-01T00:00:00Z"==e?"???":moment(e).format(a||t.options.dateFormat)},formatBytes:function(e){for(var a,n=0,r=t.options.byteSuffix.length,i=parseInt(e,10);n<r&&(a=t.options.byteSuffix[n],!(i<1024));)i/=1024,n++;return(i=Math.round(100*i)/100)+" "+a},contains:function(t,a){return e.inArray(a,t)>=0}})),t.$target.trigger("update"),t.scrollIntoView()},update:function(){var t=this,a=e(t.options.displayAs).filter(":checked");t.$target.removeClass("solrSearchHitsList solrSearchHitsGrid"),"list"==t.options.defaultDisplay&&!a.length||"list"==a.val()?t.$target.addClass("solrSearchHitsList"):t.$target.addClass("solrSearchHitsGrid")},init:function(){var t=this;t._super(),e(t.options.displayAs).on("change",(function(){t.update()})),e(t.options.displayAs).filter("[value='"+t.options.defaultDisplay+"']").prop("checked",!0),t._isFirst=!0,t.update()}}),AjaxSolr.Helpers.build("ResultWidget")}(jQuery),function(e){AjaxSolr.SearchBoxWidget=AjaxSolr.AbstractTextWidget.extend({defaults:{instantSearch:!1,instantSearchDelay:750,instantSearchMinChars:3},$input:null,timeoutID:null,afterRequest:function(){var e=this,t=e.manager.store.get("q");t&&e.$input&&e.$input.val(t.val())},autoSubmit:function(){var e=this;e.timeoutID&&(window.clearTimeout(e.timeoutID),e.manager.xhr&&e.manager.xhr.abort()),e.timeoutID=window.setTimeout((function(){e.$target.trigger("submit")}),e.options.instantSearchDelay)},init:function(){var t=this;t._super(),t.$target=e(t.target),t.$input=t.$target.find(".solrSearchField"),t.options=e.extend({},t.defaults,t.options,t.$target.data()),t.options.instantSearch&&t.$input.on("input",(function(e){var a=t.$input.val().trim();(!a.length||a.length>=t.options.instantSearchMinChars)&&t.autoSubmit()})),t.$target.on("submit",(function(){var e=t.$input.val();return t.set(e)&&t.manager.doRequest(0),!1}))}}),AjaxSolr.Helpers.build("SearchBoxWidget")}(jQuery),function(e){AjaxSolr.CurrentSelectionWidget=AjaxSolr.AbstractJQueryWidget.extend({options:{defaultQuery:"",templateName:"#solrCurrentSelectionTemplate",keywordText:"keyword"},template:null,selectionContainer:null,getKeyOfValue:function(e,t){var a,n,r=t.replace(/^[\(\[]?(.*?)[\]\)]?$/,"$1"),i=this.manager.response.responseHeader.params,o=["facet.field","facet.query","facet.date"],s=/\s*([^=]+)='?([^'=]+)'?\s*/g;for(var l in t=t.replace(/([\[\]\.\*\?\+\-\(\)])/g,"\\$1"),o)for(var c in i[o[l]])if(n=i[o[l]][c].match("^{!(.*)}\\w+:"+t))for(n=n[1];null!=(a=s.exec(n));)if("key"==a[1])return a[2];if("web"==e){for(var u=r.split(/ /),d=(l=0,u.length);l<d;l++)u[l]=_(u[l].replace(/\./g,"/"));return u.join(", ")}return _(r)},afterRequest:function(){var e,t,a,n,r=this,i=r.manager.store.values("fq"),o=r.manager.store.get("q").val(),s=0;r.clearSelection(),o&&o!==r.options.defaultQuery&&(s++,r.addSelection(r.options.keywordText,o,(function(){r.manager.store.get("q").val(r.options.defaultQuery),r.manager.doRequest(0)})));for(var l=0,c=i.length;l<c;l++)i[l]&&!r.manager.store.isHidden("fq="+i[l])&&(s++,t=(e=i[l].match(/^(?:{!.*?})?(.*?):(.*)$/))[1],a=e[2],n=r.getKeyOfValue(t,a),r.addSelection(t,n,r.removeFacet(t,a)));s&&(r.$target.find(".solrNoSelection").hide(),r.$target.find(".solrClear").show())},clearSelection:function(){var e=this;e.selectionContainer.children().not(".solrNoSelection").remove(),e.$target.find(".solrNoSelection").show(),e.$target.find(".solrClear").hide()},addSelection:function(t,a,n){t.match(/^([\-\+])/)&&(t=t.substr(1),a=RegExp.$1+a),this.selectionContainer.append(e(this.template.render({id:AjaxSolr.Helpers.getUniqueID(),field:_(t),facet:a})).on("change",n))},removeFacet:function(e,t){var a=this;return function(){a.manager.store.removeByValue("fq",e+":"+AjaxSolr.Parameter.escapeValue(t))&&a.manager.doRequest(0)}},init:function(){var t=this;t._super(),t.template=e.templates(t.options.templateName),t.selectionContainer=t.$target.children("ul:first"),t.$target.find(".solrClear").on("click",(function(){t.clearSelection()}))}}),AjaxSolr.Helpers.build("CurrentSelectionWidget")}(jQuery),function(e){AjaxSolr.SortWidget=AjaxSolr.AbstractJQueryWidget.extend({defaults:{defaultSort:"score desc"},update:function(e){e=e||this.defaults.defaultSort,this.manager.store.addByValue("sort",e)},afterRequest:function(){var e,t=this,a=t.manager.store.get("sort");a&&(e=a.val()),e=e||t.defaults.defaultSort,t.$target.find("option").prop("selected",!1),t.$target.find("[value='"+e+"']").prop("selected",!0)},init:function(){var t=this;t._super(),e.extend(t.defaults,t.$target.data()),"score desc"!==t.defaults.defaultSort&&t.manager.store.addByValue("sort",t.defaults.defaultSort),t.$target.on("change",(function(){t.update(e(this).val()),t.manager.doRequest(0)}))}}),AjaxSolr.Helpers.build("SortWidget")}(jQuery),function(e){AjaxSolr.TagCloudWidget=AjaxSolr.AbstractJQueryFacetWidget.extend({defaults:{title:"title not set",buckets:20,offset:11,container:".solrTagCloudContainer",normalize:!0,facetMincount:1,facetLimit:100,templateName:"#solrTagCloudTemplate",startColor:[104,144,184],endColor:[0,102,255]},$container:null,template:null,facetType:"facet_fields",getFacetCounts:function(){var t,a=this,n=a._super(),r=-1,i=0,o=1,s={};e.each(a.getQueryValues(a.getParams()),(function(e,t){s[t.replace(/^"(.*)"$/,"$1")]=!0})),e.each(n,(function(e,t){a.options.normalize?t.normCount=Math.log(t.count):t.normCount=t.count,t.normCount>i&&(i=t.normCount),(t.normCount<r||r<0)&&(r=t.normCount)})),(t=i-r)&&(o=t/(a.options.buckets-1)),n.sort((function(e,t){var a=e.facet.toLowerCase(),n=t.facet.toLowerCase();return a<n?-1:a>n?1:0}));var l="";return e.each(n,(function(e,t){var n=t.facet.substr(0,1).toUpperCase();t.weight=Math.round((t.normCount-r)/o)+a.options.offset+1,t.color=a.fadeRGB(t.weight),n==l?t.group="":(t.group=" <strong>"+n+"</strong>&nbsp;",l=n),t.current=s[t.facet]?"current":""})),n},fadeRGB:function(e){var t=this,a=t.options.buckets+t.options.offset;return"rgb("+Math.round(t.options.startColor[0]*(a-e)/a+t.options.endColor[0]*e/a)+","+Math.round(t.options.startColor[1]*(a-e)/a+t.options.endColor[1]*e/a)+","+Math.round(t.options.startColor[2]*(a-e)/a+t.options.endColor[2]*e/a)+")"},afterRequest:function(){var t=this,a=t.getFacetCounts();a.length?(t.$target.show(),t.$container.empty(),t.$container.append(t.template.render(a)),t.$container.find("a").on("click",(function(){var a=e(this),n=e(this).text();return a.is(".current")?t.unclickHandler(n).apply(t):t.clickHandler(n).apply(t),!1}))):t.$target.hide()},init:function(){var t=this;t._super(),t.$container=t.$target.find(t.options.container),t.template=e.templates(t.options.templateName),t.multivalue=!0}}),AjaxSolr.Helpers.build("TagCloudWidget")}(jQuery),function(e){AjaxSolr.HierarchyWidget=AjaxSolr.AbstractJQueryFacetWidget.extend({defaults:{templateName:"#solrHierarchyTemplate",container:".solrHierarchyContainer",breadcrumbs:".solrHierarchyBreadcrumbsContainer",hideNullValues:!1,hideSingle:!1,name:null},updateHierarchy:function(){var t,a=this;return void 0===a.hierarchy&&(e.ajax({url:foswiki.getScriptUrl("rest","SolrPlugin","webHierarchy"),async:!1,data:{web:a.options.web},success:function(e){a.hierarchy=e}}),t=AjaxSolr.Dicts.default,e.each(a.hierarchy,(function(e,a){var n=a.id,r=a.title,i=a.id.split(/\s*\.\s*/).pop();t.set(n,r),t.set(i,r)}))),a.hierarchy},getChildren:function(t){var a=this,n=[];return void 0!==t?void 0!==a.hierarchy[t].children&&void 0!==a.hierarchy[t]&&e.each(a.hierarchy[t].children,(function(e,t){var r=a.hierarchy[t];a.options.hideNullValues&&!a.facetCounts[t]||n.push(r)})):e.each(a.hierarchy,(function(e,t){void 0!==t.parent||a.options.hideNullValues&&!a.facetCounts[t.id]&&"web"!=t.type||n.push(t)})),n.sort((function(e,t){return e.title<t.title?-1:e.title>t.title?1:0}))},afterRequest:function(){var t,a,n=this,r={},i=[],o=[];n.$target.hide(),n.facetCounts=n.getFacetCounts(),void 0!==n.facetCounts&&0!=n.facetCounts.length&&(e.each(n.facetCounts,(function(e,t){r[t.facet]=t.count})),n.facetCounts=r,this.options.hideSingle&&1==n.facetCounts.length||void 0!==(a=n.getQueryValues(n.getParams()))&&(void 0===(a=a[0])&&(void 0!==n.options.web&&(a=n.options.web),void 0!==n.options.root&&(a+="."+n.options.root)),n.breadcrumbs.empty(),i.push("<a href='#' class='solrFacetValue root' data-value='"+a+"'>"+_("Root")+"</a>"),void 0!==a&&e.each(a.split(/\s*\.\s*/),(function(e,t){o.push(t),i.push("<a href='#' class='solrFacetValue' data-value='"+o.join(".")+"'>"+_(t)+"</a>")})),n.breadcrumbs.append(i.join("&nbsp;&#187; ")),t=n.getChildren(a),n.$target.show(),n.container.html(n.template.render(t,{renderFacetCount:function(e){var t=n.facetCounts[e];return t?"<span class='solrHierarchyFacetCount'>("+t+")</span>":""},getCategory:function(e){return n.hierarchy[e]},getChildren:function(){return n.getChildren(this.data.id)}})),void 0!==a&&n.container.find("a.cat_"+a.replace(/\./g,"\\.")).addClass("current"),n.container.parent().find("a").on("click",(function(){var t=e(this),a=e(this).data("value");return t.is(".root")?n.unclickHandler(a).apply(n):n.clickHandler(a).apply(n),!1}))))},init:function(){var t=this;t._super(),t.template=e.templates(t.options.templateName),t.container=t.$target.find(t.options.container),t.breadcrumbs=t.$target.find(t.options.breadcrumbs),t.updateHierarchy()}}),AjaxSolr.Helpers.build("HierarchyWidget")}(jQuery),function(e){AjaxSolr.SpellcheckWidget=AjaxSolr.AbstractSpellcheckWidget.extend({defaults:{spellcheck:!0,"spellcheck.count":3,"spellcheck.collate":!0,"spellcheck.onlyMorePopular":!1,"spellcheck.maxCollations":3,"spellcheck.maxCollationTries":10,templateName:"#solrSpellCorrectionTemplate"},options:{},$target:null,template:null,beforeRequest:function(){this._super(),this.$target.empty()},handleSuggestions:function(){var t=this;t.$target.html(t.template.render({suggestions:t.suggestions})),t.$target.find("a").on("click",(function(){return t.manager.store.addByValue("q",e(this).text()),t.manager.doRequest(0),!1}))},init:function(){var t=this;for(var a in t.$target=e(t.target),t.options=e.extend({},t.defaults,t.options,t.$target.data()),t.template=e.templates(t.options.templateName),t.options)a.match(/^spellcheck/)&&t.manager.store.addByValue(a,t.options[a])}}),AjaxSolr.Helpers.build("SpellcheckWidget")}(jQuery),function(e){AjaxSolr.PageLengthWidget=AjaxSolr.AbstractJQueryWidget.extend({defaults:{rows:20},update:function(e){e=e||this.defaults.rows,this.manager.store.addByValue("rows",e)},afterRequest:function(){var e=this.manager.store.get("rows").val();this.$target.find("option[value='"+e+"']").prop("selected",!0)},init:function(){var t=this;t._super(),e.extend(t.defaults,t.$target.data()),t.$target.find("select").on("change",(function(){t.update(e(this).val()),t.manager.doRequest(0)}))}}),AjaxSolr.Helpers.build("PageLengthWidget")}(jQuery);
